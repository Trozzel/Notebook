# Diesel Setup
üìù NOTE:
- Most of this is taken from [Diesel setup instructions](https://diesel.rs/guides/getting-started)
- For specifics on using Mysql, [see this link](https://github.com/diesel-rs/diesel/tree/master/examples/mysql)


## Initializing a new project

Generate a new project
```bash
cargo new --lib diesel_demo
cd diesel_demo
```

Add the appropriate dependencies to `Cargo.toml`
```toml
[package]
name = "theflow"
version = "0.1.0"
edition = "2021"

[dependencies]
diesel = { version = "2.1.0", features = ["mysql", "chrono"] }
dotenvy = "0.15"
chrono = "0.4"
serde = { version = "1.0.130", features = ["derive"] }
serde_json = "1.0.68"
```

## Installing Diesel CLI

```bash
cargo isntall diesel_cli
```

## Setup Diesel for your project

You need to tell Diesel where to find your database.
1. You can `diesel migration <subcommand> --database-url <uri>`
2. Set `DATABASE_URL` in local .env file

We will choose option 2

```bash
echo DATABASE_URL=mysql://root:my-secret-pw@gtddb/gtddb > .env
```

From here, Diesel sets everything up for us...

```bash
diesel setup
```

This creates:
1. an empty database with diesel metadata
2. And empty `migration` folder at the project root

### Create first table: "contexts" using the `diesel migration` tool

```bash
diesel migration generate contexts
```
This creates two empy files in the `migrations` folder:
```bash
Creating migrations/20240815133237_create_contexts/up.sql
Creating migrations/20240815133237_create_contexts/down.sql
```

#### Write your SQL Code
1. Enter your `up.sql` that was generated by the `diesel migration generate contexts` command
```sql
<--migrations/<date>/up.sql>
CREATE TABLE
  contexts (
    unique_id BIGINT PRIMARY KEY AUTO_INCREMENT UNIQUE NOT NULL,
    name TEXT NOT NULL,
    parent_id BIGINT DEFAULT NULL,
    status CHAR(7) NOT NULL DEFAULT "Active" CHECK (
      status = "Active"
      OR status = "OnHold"
      OR status = "Dropped"
    ),
    created DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    modified DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    notes TEXT,
    CONSTRAINT FOREIGN KEY fk_contexts_parent_id (parent_id) REFERENCES contexts (unique_id) ON DELETE SET NULL
  );
```

2. Enter the following for your `down.sql` generated by the `diesel migration generate contexts` command
```sql
<--migrations/<date>/down.sql>
DROP TABLE contexts;
```

3. Repeat steps 2 and 3 for all tables (i.e. folders, projects, tasks)

*To rollback...*
> `$ diesel migration redo`

#### Apply SQL Code to Database
Now it's time to add the tables to the database

```bash
diesel migration run
```

<hr/>

## Writing Rust Code

1. Establish a connection to the database

```rust
// src/lib.rs
pub mod models;
pub mod schema;

//use diesel::mysql::MysqlConnection;
use diesel::prelude::*;
use dotenvy::dotenv;
use std::env;

/// Establish and return the database connection
pub fn establish_connection() -> MysqlConnection {
    dotenv().ok();

    let database_url = env::var("DATABASE_URL").expect("DATABASE_URL must be set");
    MysqlConnection::establish(&database_url)
        .unwrap_or_else(|_| panic!("Error connecting to {}", database_url))
}
```
üìù NOTE: we declared two modules, `modules` and `schemas` that we will have to declare
- `models`: Rust structs that will enable rust interaction with the database data
- `schema`: Auto-generated by diesel. Translation tables between db and rust
Our only responsibility is to create the `models` module

2. Create them `models` module

```rust
// src/models.rs
use diesel::prelude::*;
use chrono::prelude::*;

#[derive(Queryable, Selectable)]
#[diesel(table_name = crate::schema::contexts)]
#[diesel(check_for_backend(diesel::mysql::Mysql))]
pub struct Context {
    pub unique_id: i64,
    pub name: String,
    pub parent_id: Option<i64>,
    pub status: String,
    pub created: NaiveDateTime,
    pub modified: NaiveDateTime,
    pub notes: Option<String>,
}

#[derive(Queryable, Selectable)]
#[diesel(table_name = crate::schema::contexts)]
#[diesel(check_for_backend(diesel::mysql::Mysql))]
pub struct Folder {
    pub unique_id: i64,
    pub name: String,
    pub parent_id: Option<i64>,
    pub status: String,
    pub created: NaiveDateTime,
    pub modified: NaiveDateTime,
    pub notes: Option<String>,
}

#[derive(Queryable, Selectable)]
#[diesel(table_name = crate::schema::contexts)]
#[diesel(check_for_backend(diesel::mysql::Mysql))]
pub struct Project {
    pub unique_id: i64,
    pub name: String,
    pub parent_id: Option<i64>,
    pub status: String,
    pub created: NaiveDateTime,
    pub modified: NaiveDateTime,
    pub notes: Option<String>,
    pub context_id: Option<i64>,
    pub folder_id: Option<i64>,
    pub flagged: bool,
    pub deferred: Option<NaiveDateTime>,
    pub due: Option<NaiveDateTime>,
    pub is_repeating: bool,
    pub repeat_from: String,
    pub repeat_schedule: String,
    pub complete_with_last: bool,
    pub review_schedule: String,
    pub project_type: String,
}

#[derive(Queryable, Selectable)]
#[diesel(table_name = crate::schema::contexts)]
#[diesel(check_for_backend(diesel::mysql::Mysql))]
pub struct Task {
    pub unique_id: i64,
    pub name: String,
    pub parent_id: Option<i64>,
    pub status: String,
    pub created: NaiveDateTime,
    pub modified: NaiveDateTime,
    pub notes: Option<String>,
    pub context_id: Option<i64>,
    pub project_id: Option<i64>,
    pub flagged: bool,
    pub deferred: Option<NaiveDateTime>,
    pub due: Option<NaiveDateTime>,
    pub is_repeating: bool,
    pub repeat_from: String,
    pub repeat_schedule: String,
    pub task_type: String,
}
```

### Create code to `SELECT` and display queries

This won't display anything yet, since we have not entered any data into the database
```rust
// src/bin/show_contents.rs
use self::models::*;
use diesel::prelude::*;
use theflow::*;

fn main() {
    // lets us access posts directly
    use self::schema::contexts::dsl::*;

    let connection = &mut establish_connection();
    let results = contexts
        .filter(name.eq("George"))
        .limit(5)
        .select(Context::as_select())
        .load(connection)
        .expect("Error loading contexts");

    println!("Displaying {} contexts", results.len());
    for context in results {
        println!("{}", context.name);
        println!("----------");
    }
}
```

üìù NOTE: `use self::schema::contexts::dsl::*` allows the use of calling `contexts` instead of `contexts::table` and `name` instead of `contexts:name`

To run at the command line:
```bash
cargo run --bin theflow
```

---

## Information on Inserts

See the following link for details on INSERTs

[Diesel - All About Inserts](https://diesel.rs/guides/all-about-inserts.html)

#### Important takeaways:
1. Using `use schema::<table>::dsl::*;`
    1. If you use the `use schema::<table>::dsl::*;`, helper call, do so *at the top of the function* and not at the top of the file.
    2. If you choose to write out the complete namespace, it will look like this, for writing to a table:
    ```rust
    insert_into(<table>::table)
    ```
    3. For working with specific columns / fields:
    ```rust
    <table>::<column>
    ```
2. To see the SQL query statement of a query:
    ```rust
    println!("{}", debug_query::<Mysql, _>(&query_name));
    ```
    This will show something similar to the following:
    ```sql
    INSERT INTO "<table>" DEFAULT VALUES
    ```
3. To enter specific values into a table, use the `.values()` method.
    ```rust
    insert_into(<table>::table).values(<table>::<column>.eq("<your value>")).execute(conn)
    ```
    *Where* `conn` *is* `&mut MysqlConnection`
4. For bulk inserts, just pass a tuple. The following is an example:
    ```rust
    insert_into(users::table)
        .values(
            (users::name.eq("George"), users::hair_color.eq("Brown")),
            (users::name.eq("Trinity"), users::hair_color.eq("Light Brown"))
        )
        .execute(conn)
    ```
5. **Concerning** `Option` **fields**
You can pass `Some(<value>)` or `None` directly to the `values` method and it will auto-populate the record with default values.
    - [See Diesel's documentation here](https://diesel.rs/guides/all-about-inserts.html#:~:text=Once%20again%2C%20we%20can%20use%20an%20Option%20for%20any%20of%20the%20fields%20to%20insert%20DEFAULT.)
    ```rust
    insert_into(users)
    .values(&vec![
        (name.eq("Sean"), Some(hair_color.eq("Black"))),
        (name.eq("Ruby"), None),
    ])
    .execute(conn)
    ```

6. Using Serde for serialization and deserialization
    1. At top of file: `use serde::Deserialize`
    2. 


